## Progress Log — 2025-10-17

### 2025-10-22
### 2025-10-23
#### Highlights
- Locked `/api/audit` behind team-aware filtering and required callers to provide a `teamId` header or explicit `entityId`, preventing cross-team leakage when multiple clubs share infra.
- Normalised roster audit events in the UI, deriving player names from structured payloads and mapping backend actions (created/updated/restored) into the Season Stats log so historical edits render accurately.
- Added coverage for the new audit service filter and refreshed Vitest mocks to include persistence helpers, keeping both backend and frontend suites green (`npm test -- --run --pool=threads`).
- Season snapshot + match reload paths now push the active team context through API calls and surface a friendly warning when `VITE_USE_API=true` but `VITE_TEAM_ID` is missing, so staff know why the UI is in local-only mode.
- Post-match edits in Season Stats now re-fetch backend summaries immediately, keeping win/loss tallies and player minutes aligned without a page reload.
- Added API-mode regression coverage to SeasonStatsView to ensure saving a match re-queries backend stats and match lists.
- Roster persistence mirrors the same team-aware logic, including UI warnings when API mode lacks a configured team ID and tests around fallback messaging.
- Implemented authentication & CSRF middleware across Vercel API routes with a dedicated `/api/session/csrf` issuer; client calls now attach signed session headers and double-submit CSRF tokens by default.
- API routes now enforce `x-ffm-session` signatures, role checks, and CSRF headers via a shared security module; the client auto-fetches tokens and the README documents setup steps.
- Added integration-style Vitest coverage for `/api/players` and `/api/fixtures`, exercising 401/403 paths and confirming CSRF enforcement in happy paths.
- Extended security tests to `/api/audit` and `/api/rulesets/active`, covering missing-session, bad team context, and successful responses.
- Backend now hard-fails when `DATABASE_URL` is missing and frontend logs a warning if CSRF setup fails during API mode dev sessions.

#### Outstanding Items
- Extend team scoping to any future audit entity (e.g. imports, rulesets) once those endpoints land.
- Verify roster mutations and pick-a-team flows also push explicit team IDs through API helpers (post-squad edits should maintain sync).
- Continue ASVS hardening: CSRF protection for POST routes, route-level authorisation middleware, and environment validation.

#### Tomorrow’s Focus
1. Add integration tests covering security middleware failure paths (missing session, missing CSRF) for fixtures/players endpoints.
2. Finish documentation for environment validation and production deployment checklist.

### Summary
- Bootstrapped the app with `data/imported-matches.json` so legacy Excel data populates roster + match history automatically (`ensureSeedData`).
- Match confirmation now captures full result metadata (venue, outcome, scoreline, scorers, player-of-the-match, honorable mentions) which feeds the season dashboard.
- Season Stats tab displays a “Season Snapshot”, extended player summary (minutes, goals, awards, honorable mentions), and expandable match editors with quarter-by-quarter grids that reuse the slot modal.
- Roster management (add/remove/restore) is shared between Match Setup and Season Stats; restores update both the active list and audit log.
- Persistence utilities accept richer updates (result fields, allocation rewrites) with audit events, and tests cover the new behaviour.
- Initial backend integration: roster and fixture flows can point to the Postgres API via feature flags with automatic fallback to legacy localStorage for offline/legacy paths.
- Backend now records per-player match stats on result submission, and REST endpoints expose aggregated team/player season summaries for the UI.
- Season + Match tabs consume backend stats when available, automatically reloading lineups/results after confirm or edit operations.

### Current Behaviour Checklist
- **Landing/Match Setup**: select active players from roster, generate allocation, set GK overrides, confirm match with full stat entry (creates season entry immediately).
- **Season Stats**:
  - Season snapshot: matches played, goals for/against, record, goal difference.
  - Player table: total minutes, matches, GK quarters, target minutes, goals, POTM awards, honorable mentions.
  - Expand a match to edit metadata, see scorers/POTM recap, and modify quarter assignments via modal.
  - Roster overview panel: active vs removed counts, restore with audit entry.
  - Audit log: match edits and roster changes.
- **Data**: seeded from `data/imported-matches.json` on first load; new matches appended via Confirm flow; Excel importer still outputs updated JSON.
- **Tests**: `npm test -- --run` passes (46 tests).

### Known Gaps / Next Steps
1. Wire frontend to new Postgres-backed APIs for fixtures/roster (feature flag roll-out in progress).
2. Live rules propagation (allocator + UI responding without reload).
3. Additional analytics: per-opponent summaries, average minutes vs target, export tooling.
4. Alerting / pre-match fairness warnings on the front page.
5. Polish match editor UX (bulk substitutions, timeline view) once backend is in place.

### Handy Commands
- Seed import (rerun if data changes): `npm run import:legacy`
- Dev server: `npm run dev`
- Tests: `npm test -- --run`

### Files of Interest
- `src/lib/bootstrap.ts` – handles seeding from JSON.
- `src/components/ConfirmTeamModal.tsx` – captures match details.
- `src/components/SeasonStatsView.tsx` – dashboard + editors.
- `src/lib/persistence.ts` – save/update logic with audit trail.
